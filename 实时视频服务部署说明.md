# 实时视频服务部署完整指南

## 项目概述
本项目为你的首页集成了实时视频服务，支持OBS Studio推流，在网页端实现：
- 摄像头图标悬停时显示实时截图预览
- 点击摄像头图标观看全屏实时视频
- 支持多路视频流同时推送

## 部署步骤

### 第一步：安装必要软件

#### 1. 安装FFmpeg
- 访问 https://ffmpeg.org/download.html
- 下载Windows版本并解压
- 将ffmpeg.exe添加到系统PATH环境变量中
- 在命令行测试：`ffmpeg -version`

#### 2. 安装Node.js依赖
```bash
cd belt
npm install node-media-server fluent-ffmpeg express cors nodemon
```

### 第二步：启动流媒体服务器

#### 方法一：使用批处理文件（推荐）
```bash
cd belt
双击运行 start-streaming.bat
```

#### 方法二：手动启动
```bash
cd belt
node rtmp-server.js
```

#### 成功启动的标志
看到以下输出表示服务器启动成功：
```
RTMP服务器已启动:
- RTMP推流地址: rtmp://localhost:1935/live/
- HTTP服务地址: http://localhost:8000/
- HLS播放地址: http://localhost:8000/hls/{stream_name}/index.m3u8
- 截图访问地址: http://localhost:8000/snapshots/{stream_name}_latest.jpg
```

### 第三步：配置OBS Studio
详细配置步骤请参考：`OBS_配置指南.md`

#### 快速配置要点：
1. **推流设置**：
   - 服务器：`rtmp://localhost:1935/live`
   - 推流密钥：`camera1` 或 `camera2`

2. **输出设置**：
   - 视频比特率：2500 Kbps
   - 分辨率：1280x720
   - 帧率：30fps

### 第四步：启动前端应用
```bash
cd belt
npm run serve
```

### 第五步：测试功能

#### 1. 开始推流
- 在OBS中点击"开始推流"
- 等待10-15秒让HLS转换生效

#### 2. 测试悬停预览
- 打开网页应用首页
- 将鼠标悬停在摄像头图标上
- 应该看到实时截图预览和LIVE指示器

#### 3. 测试全屏播放
- 点击摄像头图标
- 弹出全屏视频播放窗口
- 应该能看到实时视频流

## 技术架构

### 流媒体处理流程
```
OBS Studio → RTMP推流 → Node Media Server → HLS转换 → Web播放
                                        ↓
                                   实时截图生成
```

### 关键组件
1. **RTMP服务器**：接收OBS推流
2. **HLS转换器**：将RTMP转为Web兼容格式
3. **截图服务**：每5秒生成一张预览图
4. **Vue前端**：展示视频和处理交互

### 端口使用
- **1935**：RTMP推流端口
- **8000**：HTTP服务端口（HLS和截图）
- **8080**：Vue开发服务器端口

## 文件说明

### 新增文件
- `rtmp-server.js` - RTMP流媒体服务器
- `streaming-package.json` - 流媒体服务依赖配置
- `start-streaming.bat` - 服务器启动脚本
- `OBS_配置指南.md` - OBS配置详细说明
- `实时视频服务部署说明.md` - 本文档

### 修改文件
- `src/views/HomeView.vue` - 首页组件，新增视频流功能

### 生成目录
- `public/hls/` - HLS视频片段存储
- `public/snapshots/` - 实时截图存储

## 功能特性

### 1. 实时预览
- 鼠标悬停摄像头图标时显示最新截图
- LIVE指示器显示推流状态
- 自动刷新预览图片

### 2. 全屏播放
- 点击图标打开全屏播放窗口
- 支持HTML5视频控制
- 显示推流状态和设备信息

### 3. 多流支持
- 支持camera1和camera2两路流
- 可扩展支持更多摄像头
- 独立的推流状态监控

### 4. 自动监控
- 每10秒检查推流状态
- 自动更新在线/离线状态
- 错误处理和用户提示

## 故障排除

### 常见问题

#### 1. 服务器启动失败
**原因**：依赖包未安装或FFmpeg未配置
**解决**：
```bash
npm install node-media-server fluent-ffmpeg express cors
# 确保FFmpeg在PATH中
ffmpeg -version
```

#### 2. OBS推流连接失败
**原因**：RTMP服务器未启动或端口被占用
**解决**：
- 检查1935端口是否被占用
- 确认防火墙设置
- 重启RTMP服务器

#### 3. 网页端看不到视频
**原因**：HLS转换需要时间或浏览器兼容性
**解决**：
- 等待15-20秒
- 刷新页面
- 检查浏览器控制台错误
- 尝试Chrome或Edge浏览器

#### 4. 预览图片不更新
**原因**：截图生成失败或缓存问题
**解决**：
- 检查snapshots目录权限
- 清除浏览器缓存
- 重启推流

### 日志查看
- **RTMP服务器日志**：控制台输出
- **OBS推流日志**：OBS菜单 → 帮助 → 日志文件
- **浏览器日志**：F12开发者工具 → Console

## 扩展功能

### 1. 添加更多摄像头
在`HomeView.vue`中的`cameraData`数组添加新项：
```javascript
{
  id: 3,
  device_name: '摄像机3',
  stream_name: 'camera3',
  // ...其他配置
}
```

### 2. 自定义视频参数
修改`rtmp-server.js`中的ffmpeg参数：
```javascript
'-hls_time 5',      // 片段长度
'-maxrate 1000k',   // 最大比特率
'-s 1280x720'       // 分辨率
```

### 3. 录制功能
可以扩展添加视频录制功能：
```javascript
// 在rtmp-server.js中添加录制逻辑
ffmpeg(inputUrl)
  .output('recordings/recording.mp4')
  .run();
```

## 性能优化

### 1. 服务器优化
- 使用硬件编码器
- 调整HLS片段大小
- 启用压缩传输

### 2. 网络优化
- 配置CDN分发
- 启用HTTP/2
- 使用WebRTC降低延迟

### 3. 前端优化
- 懒加载视频组件
- 预加载关键帧
- 优化CSS动画

## 安全考虑

### 1. 访问控制
- 添加推流密钥验证
- 限制推流IP范围
- 实现用户认证

### 2. 资源保护
- 限制并发连接数
- 设置带宽限制
- 定期清理临时文件

## 技术支持

如遇到问题，请按以下顺序排查：
1. 检查所有服务是否正常启动
2. 查看相关日志文件
3. 验证网络连接和端口状态
4. 测试各个组件的独立功能
5. 参考本文档的故障排除部分

更多技术细节请查看源代码注释和相关配置文件。
