# 🔧 FLV播放器跨域问题解决方案

## ❌ 错误信息
```
播放失败: NetworkError - Exception
```

这个错误通常是由**跨域（CORS）问题**或**网络连接问题**引起的。

---

## 🎯 解决方案

### 方案1：配置ZLMediaKit允许跨域（推荐）

#### 1. 找到ZLMediaKit的配置文件 `config.ini`

#### 2. 修改HTTP配置部分

```ini
[http]
port=80
sslport=443
# 关键配置：允许跨域
allow_cross_domains=1
keep_alive_second=100
max_req_size=40960
send_buf_size=65536
recv_buf_size=65536
```

#### 3. 重启ZLMediaKit服务

```bash
# Windows
停止MediaServer.exe后重新运行

# Linux
killall MediaServer
./MediaServer -c config.ini
```

---

### 方案2：使用Nginx反向代理（推荐用于生产环境）

#### 1. 安装Nginx（Windows下载：https://nginx.org/）

#### 2. 配置nginx.conf

```nginx
http {
    server {
        listen 8080;
        server_name localhost;
        
        # 添加CORS头
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        add_header Access-Control-Expose-Headers 'Content-Length,Content-Range';
        
        # 代理到ZLMediaKit
        location /live/ {
            proxy_pass http://localhost:80/live/;
            proxy_buffering off;
            proxy_cache off;
        }
    }
}
```

#### 3. 启动Nginx并修改流地址

```bash
# 启动Nginx
nginx.exe

# 然后使用Nginx地址
http://localhost:8080/live/camera1.live.flv
```

---

### 方案3：在Vue项目中配置代理（开发环境）

#### 1. 修改 `vue.config.js`（如果没有则创建）

```javascript
module.exports = {
  devServer: {
    proxy: {
      '/live': {
        target: 'http://localhost:80',  // ZLMediaKit地址
        changeOrigin: true,
        ws: true
      }
    }
  }
}
```

#### 2. 重启开发服务器

```bash
npm run serve
```

#### 3. 使用相对路径访问

```
/live/camera1.live.flv
```

---

### 方案4：使用Chrome禁用安全策略（仅用于测试）

⚠️ **警告：仅用于开发测试，不要用于生产环境**

#### Windows:
```bash
chrome.exe --disable-web-security --user-data-dir="C:/ChromeDevSession"
```

#### Mac:
```bash
open -n -a "Google Chrome" --args --disable-web-security --user-data-dir="/tmp/chrome_dev"
```

---

## 🔍 问题诊断步骤

### 1. 检查ZLMediaKit是否运行

在浏览器打开控制台（F12），输入以下命令测试：

```javascript
fetch('http://localhost/live/camera1.live.flv')
  .then(response => {
    console.log('连接成功:', response.status)
  })
  .catch(error => {
    console.error('连接失败:', error)
  })
```

### 2. 检查网络连接

在浏览器地址栏直接访问FLV地址：
```
http://localhost/live/camera1.live.flv
```

**预期结果：**
- ✅ 浏览器会提示下载文件 → 说明服务器正常
- ❌ 无法访问/超时 → 服务器未运行或端口不对
- ❌ CORS错误 → 需要配置跨域

### 3. 查看浏览器控制台错误

打开浏览器控制台（F12），切换到Console和Network标签页，查看详细错误信息。

常见错误：
```
Access to fetch at 'http://localhost/live/xxx.flv' from origin 'http://localhost:8080' 
has been blocked by CORS policy
```
→ 这是跨域问题，使用方案1或方案2解决

---

## 📝 ZLMediaKit完整配置示例

### config.ini

```ini
[general]
# 是否启用虚拟主机
enableVhost=0

[http]
# HTTP服务端口
port=80
# HTTPS服务端口
sslport=443
# 允许跨域访问
allow_cross_domains=1
# 字符编码
charSet=utf-8
# 404根目录
rootPath=./www
# 虚拟主机根目录
notFound=<html><head><title>404 Not Found</title></head><body bgcolor="white"><center><h1>您访问的资源不存在！</h1></center></body></html>
# 设置socket临时性收发缓存
send_buf_size=65536
recv_buf_size=65536

[rtmp]
# rtmp服务器端口
port=1935

[rtsp]
# rtsp服务器端口
port=554

[protocol]
# 是否启用HLS协议
enable_hls=1
# 是否启用RTSP协议
enable_rtsp=1
# 是否启用RTMP协议
enable_rtmp=1
# 是否启用HTTP-FLV协议
enable_ts=1
# 是否启用HTTP-FMP4协议
enable_fmp4=0
```

---

## 🚀 推荐配置（生产环境）

### 架构：
```
浏览器 → Nginx (8080) → ZLMediaKit (80)
                ↓
            跨域头处理
```

### 优点：
✅ 解决跨域问题  
✅ 负载均衡  
✅ SSL/HTTPS支持  
✅ 缓存优化  
✅ 安全性更高  

---

## 💡 快速测试

### 1. 测试推流

```bash
ffmpeg -re -i test.mp4 -c copy -f flv rtmp://localhost:1935/live/test
```

### 2. 测试播放

在播放器中输入：
```
http://localhost/live/test.live.flv
```

### 3. 检查ZLMediaKit API

浏览器访问：
```
http://localhost/index/api/getMediaList
```

应该能看到当前推流列表。

---

## 📞 常见问题

### Q: 为什么本地localhost可以，IP地址不行？
A: 浏览器的CORS策略对localhost有特殊处理。使用IP地址需要配置ZLMediaKit的跨域支持。

### Q: 使用HTTPS页面播放HTTP流？
A: 浏览器不允许HTTPS页面加载HTTP资源（Mixed Content）。需要：
1. 使用HTTPS流（配置ZLMediaKit SSL）
2. 或将整个网站改为HTTP（不推荐）

### Q: 移动端无法播放？
A: 
1. 检查移动端网络是否能访问服务器
2. 使用HLS协议（兼容性更好）
3. 确保使用HTTPS（iOS要求）

---

## ✅ 验证配置是否成功

### 检查清单：

- [ ] ZLMediaKit正常运行
- [ ] 能够成功推流
- [ ] 浏览器能访问FLV地址
- [ ] 控制台没有CORS错误
- [ ] 播放器能正常加载视频

---

## 🔗 相关链接

- [ZLMediaKit官方文档](https://github.com/ZLMediaKit/ZLMediaKit/wiki)
- [flv.js GitHub](https://github.com/bilibili/flv.js)
- [Nginx下载](https://nginx.org/en/download.html)

如果以上方法都无法解决，请检查：
1. 防火墙设置
2. 网络配置
3. ZLMediaKit日志文件



