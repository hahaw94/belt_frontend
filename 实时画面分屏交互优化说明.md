# 实时画面分屏交互优化说明

## 更新日期
2025-11-07

## 功能变更

### 1. 删除原有的手动输入功能
- ❌ **移除**：每个分屏内的 WebRTC 地址输入框和播放按钮
- ✅ **替换**：简洁的空闲分屏提示界面

### 2. 新增点击通道自动播放功能

#### 操作流程
1. **选择分屏**：点击任意一个分屏，使其成为当前选中状态（蓝色高亮边框）
2. **选择通道**：在左侧设备树中点击某个通道
3. **自动播放**：系统自动完成以下操作：
   - 调用后台 API 获取该通道的 WebRTC 播放地址
   - 自动解析并配置播放器参数
   - 开始播放视频流到选中的分屏
   - 分屏底部显示通道名称

#### 智能提示
- **离线通道**：点击离线通道时，系统会提示"通道离线，无法播放"
- **未选分屏**：未选择分屏时点击通道，系统会提示"请先选择一个分屏"
- **空闲分屏**：显示提示文字
  - 选中状态：「请在左侧选择通道播放」
  - 未选中状态：「点击选中此分屏」

### 3. 新增停止播放功能
- **停止按钮**：播放中的分屏右上角显示半透明的红色停止按钮
- **快速切换**：点击停止按钮后，分屏变为空闲状态，可以播放其他通道
- **自动清理**：停止时自动调用后台 API 清理资源

### 4. 优化显示效果
- **通道名称**：分屏底部信息条显示实际的通道名称，而非"通道 1"、"通道 2"等
- **响应式按钮**：停止按钮根据分屏数量自动调整大小
  - 1-4分屏：显示图标+文字
  - 9-16分屏：仅显示图标，节省空间

## 技术实现

### 核心修改文件
- `belt/src/views/detection/RealtimeDetection.vue`

### 主要修改点

#### 1. 模板部分
```vue
<!-- 移除了复杂的输入面板 -->
<!-- 新增了简洁的空闲提示 -->
<!-- 新增了停止播放按钮 -->
```

#### 2. 脚本部分
- **修改 `handleNodeClick` 函数**：实现点击通道自动播放
- **新增 `stopWebRTCPlay` 函数**：实现停止播放并清理资源
- **扩展 `webrtcPlayers` 配置**：添加 `channelInfo` 字段存储通道信息

#### 3. 样式部分
- 新增 `.empty-screen-hint` 样式：美化空闲分屏提示
- 优化 `.stop-stream-btn` 样式：不同分屏模式下的按钮适配

## API 调用

### 开始播放
```javascript
// 注意：参数使用驼峰命名
gb28181API.startWVPPreview({
  deviceId: deviceId,
  channelId: channelId
})

// 后端返回的WebRTC地址字段：
// response.data.rtc 或 response.data.rtcs
```

### 停止播放
```javascript
// 注意：参数使用驼峰命名
gb28181API.stopWVPPreview({
  deviceId: deviceId,
  channelId: channelId
})
```

### 关键字段说明
根据平台对接部分的代码，后端返回的流地址字段包括：
- `rtc`: WebRTC 播放地址（HTTP）
- `rtcs`: WebRTC 播放地址（HTTPS）
- `flv`: FLV 播放地址
- `hls`: HLS 播放地址
- 等等...

## 用户体验提升

### 操作更简单
- 从 **3步操作**（选分屏 → 输入地址 → 点播放）
- 简化为 **2步操作**（选分屏 → 点通道）

### 界面更清爽
- 移除了每个分屏内的输入框和按钮
- 空闲分屏显示简洁的提示信息
- 播放中的分屏仅显示必要的停止按钮

### 反馈更及时
- 实时显示通道在线状态（绿点/灰点）
- 离线通道自动拦截并提示
- 获取流地址过程显示加载提示
- 操作成功/失败均有明确的消息反馈

## 兼容性说明
- ✅ 保持了原有的16分屏性能优化
- ✅ 保持了原有的 WebRTC 播放器配置
- ✅ 保持了原有的设备树筛选功能
- ✅ 完全向后兼容现有的后台 API

## 后续建议

### 可选增强功能
1. **拖拽播放**：支持从左侧设备树拖拽通道到分屏
2. **批量播放**：选中多个通道后自动分配到空闲分屏
3. **通道记忆**：记住每个分屏最后播放的通道，刷新后自动恢复
4. **快捷键支持**：使用键盘快捷键切换分屏和控制播放

## 测试建议

### 功能测试
- [ ] 选择不同分屏后点击通道能正确播放
- [ ] 停止按钮能正确停止播放并清理资源
- [ ] 离线通道点击时显示正确提示
- [ ] 分屏数量切换时界面显示正常

### 性能测试
- [ ] 16分屏同时播放时性能表现
- [ ] 快速切换通道时的资源释放
- [ ] 多次停止-播放操作的稳定性

### 兼容性测试
- [ ] 不同浏览器下的播放效果
- [ ] 不同网络环境下的加载速度
- [ ] 设备树为空时的界面显示

---

## 问题修复记录

### 修复WebRTC连接断开问题，添加自动重连机制（2025-11-07）
**问题描述**：播放一会儿后出现"WebRTC 连接失败"错误，导致视频停止播放

**原因分析**：
1. 网络波动导致 WebRTC 连接暂时断开
2. 流媒体服务器在某些情况下会主动断开长时间连接
3. 原播放器没有重连机制，连接失败后直接报错
4. ICE 连接状态变化处理不完善

**解决方案**：
为 `ZLKWebRTCPlayer` 组件添加智能重连机制：
- **自动重连**：连接断开或失败时自动尝试重连
- **重连次数限制**：最多尝试 3 次重连，避免无限重连
- **重连延迟**：每次重连间隔 2 秒，给网络恢复时间
- **状态提示**：显示重连进度"重连中 (1/3)..."
- **成功重置**：重连成功后重置重连计数

**修改内容**：
1. 添加重连相关变量：`reconnectAttempts`、`maxReconnectAttempts`、`reconnectDelay`
2. 新增 `attemptReconnect()` 函数处理重连逻辑
3. 优化连接状态变化监听：
   - `disconnected` 状态：尝试重连
   - `failed` 状态：尝试重连
   - `connected` 状态：重置重连次数
4. 在 `stop()` 和组件卸载时清理重连定时器
5. 更新状态文本显示重连进度

**效果**：
- ✅ 网络短暂波动时自动恢复播放
- ✅ 减少因临时网络问题导致的播放中断
- ✅ 用户体验更流畅，无需手动重新播放
- ✅ 避免无限重连，超过次数后提示明确错误

---

### 修复设备在线状态显示问题（2025-11-07）
**问题描述**：设备树中，通道显示在线（绿点），但设备显示离线（灰点）

**原因分析**：
设备的在线状态直接使用后端返回的 `device.status` 字段，但该字段可能不准确或不存在。实际上，应该根据设备下通道的在线状态来判断设备是否在线。

**解决方案**：
改变设备在线状态的判断逻辑：
- 先将设备在线状态初始化为 `false`
- 遍历该设备下的所有通道
- 只要有任何一个通道在线，则将设备状态设置为在线

**修改内容**：
- 在 `loadDevices` 函数中，移除直接使用 `device.status` 的判断
- 添加 `hasOnlineChannel` 变量追踪通道在线状态
- 在加载完所有通道后，根据 `hasOnlineChannel` 更新设备的在线状态

**效果**：
- 如果设备有任何一个通道在线，设备节点显示绿点（在线）
- 如果设备所有通道都离线，设备节点显示灰点（离线）
- 设备和通道的在线状态显示一致

---

### 修复400错误问题（2025-11-07）
**问题描述**：点击通道播放时提示 400 错误

**原因分析**：
1. API参数命名不一致：使用了下划线命名 `device_id`、`channel_id`，但后端期望驼峰命名 `deviceId`、`channelId`
2. WebRTC地址字段提取错误：尝试读取 `webrtc_url` 字段，但后端实际返回的字段名是 `rtc` 或 `rtcs`

**解决方案**：
1. 统一使用驼峰命名调用API：`deviceId`、`channelId`
2. 正确提取WebRTC地址：优先读取 `rtc`、`rtcs` 字段
3. 参考平台管理组件中的实现逻辑（`PlatformManagement.vue`）

**修改内容**：
- 修正 `handleNodeClick` 函数中的API调用参数
- 修正 `stopWebRTCPlay` 函数中的API调用参数
- 更新WebRTC地址字段的提取逻辑
- 添加更详细的错误提示和调试信息

---

## 更新记录
- 2025-11-07: 为WebRTC播放器添加自动重连机制，提升播放稳定性
- 2025-11-07: 删除分屏上的预警标识和相关代码
- 2025-11-07: 修复设备在线状态显示逻辑，根据通道状态判断设备状态
- 2025-11-07: 修复400错误，统一API参数命名和字段提取逻辑
- 2025-11-07: 初始版本，实现点击通道自动播放功能

