# 告警信息展示更新说明

## 📋 更新概述

本次更新将前端告警信息展示模块完全对接到后端事件中心的告警信息管理API，实现了真实数据的查询、展示和处理功能。

## 🔄 更新内容

### 1. API接口更新 (`src/api/event.js`)

#### 新增API方法：
- **`getAlarmList(params)`** - 获取告警列表
  - 支持时间范围筛选
  - 支持告警类型筛选
  - 支持告警级别筛选 (1:低, 2:中, 3:高)
  - 支持处理状态筛选 (0:未处理, 1:已处理)
  - 支持分页查询

- **`getAlarmDetail(alarmId)`** - 获取告警详情
  - 查询单个告警的完整信息

- **`handleAlarm(alarmId, data)`** - 处理告警
  - 支持两种处理结果：`confirmed`(已确认) 和 `false_positive`(误报)
  - 支持添加处理备注

- **`getAlarmStatistics(params)`** - 获取告警统计信息

- **`exportFalsePositives(data)`** - 导出误报样本

- **`packageFalsePositives(data)`** - 打包误报样本

- **`getSubscription()`** - 获取用户订阅配置

- **`updateSubscription(data)`** - 更新用户订阅配置

#### 向后兼容：
保留了旧的API方法名称，映射到新的实现：
- `processAlarm` → `handleAlarm`
- `markNegativeSample` → `handleAlarm`
- `exportSamples` → `exportFalsePositives`

### 2. 告警展示页面更新 (`src/views/event/AlarmDisplay.vue`)

#### 功能增强：

**a. 搜索筛选功能**
- ✅ 时间范围筛选（使用日期时间选择器）
- ✅ 告警类型筛选（人员入侵、异常行为、可疑物品、区域入侵、烟雾检测、火灾检测）
- ✅ 告警级别筛选（低、中、高）
- ✅ 处理状态筛选（未处理、已处理）
- ✅ 移除了点位筛选（可根据需要后续添加）

**b. 列表展示**
- ✅ 从后端API实时获取数据
- ✅ 显示序号、时间、类型、级别、点位、描述、状态
- ✅ 状态标签颜色区分：
  - 未处理 - 橙色警告
  - 已确认 - 绿色成功
  - 已处理 - 蓝色信息
  - 误报 - 红色危险
- ✅ 支持加载状态显示
- ✅ 支持行点击查看详情

**c. 分页功能**
- ✅ 支持每页显示10/20/50/100条
- ✅ 支持页码跳转
- ✅ 显示总记录数

**d. 告警详情对话框**
- ✅ 重新设计详情展示布局
- ✅ 分区展示：基本信息、处理信息、描述、现场截图
- ✅ 显示完整的告警信息：
  - 告警编码
  - 告警时间
  - 告警类型
  - 告警级别（带颜色标签）
  - 点位位置
  - 处理状态
  - 处理时间（如果已处理）
  - 处理备注（如果有）
  - 告警描述
  - 现场截图（支持预览）

**e. 告警处理功能**
- ✅ 支持从列表直接处理
- ✅ 支持从详情对话框处理
- ✅ 两步确认流程：
  1. 输入处理备注（可选）
  2. 选择处理结果（已确认/误报）
- ✅ 处理成功后自动刷新列表

**f. 组件生命周期**
- ✅ 页面加载时自动获取告警列表
- ✅ 搜索、重置、分页操作后自动刷新数据

## 🔧 后端API对接说明

### API路径
所有API都使用 `/api/v1/alarms` 前缀，与后端事件中心保持一致。

### 请求参数格式

**告警列表查询：**
```javascript
GET /api/v1/alarms?start_time=2024-01-01 00:00:00&end_time=2024-12-31 23:59:59&alarm_type=person_intrusion&alarm_level=3&status=0&page=1&page_size=20
```

**告警处理：**
```javascript
POST /api/v1/alarms/:id/handle
{
  "result": "confirmed",  // 或 "false_positive"
  "remark": "已确认为真实告警"
}
```

### 响应数据映射

后端返回的字段会被映射为前端展示格式：

| 后端字段 | 前端字段 | 说明 |
|---------|---------|------|
| `alarm_type` | `type` | 映射为中文显示 |
| `alarm_level` | `level` | 1/2/3 映射为 低/中/高 |
| `alarm_time` | `time` | 告警时间 |
| `status` | `status` | 结合 `handle_result` 确定最终状态 |
| `snapshot_path` | `images` | 图片路径数组 |
| `location` / `camera_name` | `location` | 优先使用location |

### 告警类型映射

| 后端值 | 前端显示 |
|-------|---------|
| `person_intrusion` | 人员入侵 |
| `behavior` | 异常行为 |
| `object` | 可疑物品 |
| `intrusion` | 区域入侵 |
| `smoke_detection` | 烟雾检测 |
| `fire_detection` | 火灾检测 |

### 状态映射逻辑

```javascript
if (status === 0) {
  显示 "未处理"
} else if (status === 1) {
  if (is_false_positive 或 handle_result === 'false_positive') {
    显示 "误报"
  } else if (handle_result === 'confirmed') {
    显示 "已确认"
  } else {
    显示 "已处理"
  }
}
```

## 📝 使用说明

### 1. 查询告警

1. 打开"告警信息展示"页面
2. 根据需要设置筛选条件：
   - 时间范围：选择开始和结束时间
   - 告警类型：选择特定类型或全部
   - 告警级别：选择低/中/高或全部
   - 状态：选择未处理/已处理或全部
3. 点击"搜索"按钮查询
4. 点击"重置"按钮清空条件并重新加载

### 2. 查看详情

- 方式1：点击表格中的"查看"按钮
- 方式2：直接点击表格行

### 3. 处理告警

**从列表处理：**
1. 点击操作列的"处理"按钮
2. 在弹出框中输入处理备注（可选）
3. 选择处理结果（已确认/误报）
4. 系统自动保存并刷新列表

**从详情对话框处理：**
1. 查看告警详情
2. 点击"确认处理"按钮
3. 选择处理结果（已确认/误报）
4. 系统自动保存并关闭对话框

## 🎨 UI/UX改进

1. **响应式布局**：筛选条件在小屏幕上自动调整为2列布局
2. **加载状态**：查询数据时显示loading动画
3. **科技感设计**：保持原有的科技感UI风格
4. **颜色编码**：不同级别和状态使用不同颜色标识
5. **详情分区**：详情信息按类别分区展示，更清晰
6. **图片预览**：支持点击图片放大预览

## 🔒 注意事项

1. **环境变量**：确保配置了正确的 `VITE_API_BASE_URL`
2. **认证**：API调用需要有效的认证token
3. **权限**：需要 `module:event` 权限才能访问告警管理接口
4. **图片路径**：
   - 如果后端返回完整URL（http://或https://），直接使用
   - 如果返回相对路径，会自动拼接 `VITE_API_BASE_URL`

## 📚 相关文件

- **API文件**: `src/api/event.js`
- **页面组件**: `src/views/event/AlarmDisplay.vue`
- **后端文档**: `smart-video-platform/web/index.html` (事件中心API测试部分)
- **数据模型**: `smart-video-platform/internal/models/event.go`

## 🚀 后续优化建议

1. **WebSocket实时推送**：接入 `ws://localhost:8080/api/v1/ws/alarms` 实现实时告警推送
2. **统计图表**：使用 `getAlarmStatistics` API 添加统计图表展示
3. **批量操作**：支持批量处理告警
4. **导出功能**：集成误报样本导出功能
5. **点位管理**：重新添加点位筛选功能
6. **告警订阅**：添加用户订阅配置页面

## ✅ 测试清单

- [ ] 列表加载正常
- [ ] 时间范围筛选正确
- [ ] 告警类型筛选正确
- [ ] 告警级别筛选正确
- [ ] 状态筛选正确
- [ ] 分页功能正常
- [ ] 详情查看正常
- [ ] 处理告警成功
- [ ] 图片预览正常
- [ ] 状态标签颜色正确
- [ ] 响应式布局正常

---

**更新日期**: 2024-11-11
**更新人**: Cascade AI Assistant
**版本**: v2.0
