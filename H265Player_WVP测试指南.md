# H265Player - WVP 平台测试指南

## ✅ 快速验证组件支持 WVP 推流

### 测试步骤

#### 1. 获取 WVP 流地址

从 WVP 平台获取流地址，通常格式如下：

**WebSocket-FLV（推荐）：**
```
ws://192.168.1.100:18080/rtp/34020000001320000001_34020000001310000001.live.flv
```

**HTTP-FLV：**
```
http://192.168.1.100:18080/rtp/34020000001320000001_34020000001310000001.live.flv
```

**HLS：**
```
http://192.168.1.100:18080/rtp/34020000001320000001_34020000001310000001/hls.m3u8
```

#### 2. 在首页测试

1. 启动项目：
   ```bash
   npm run serve
   ```

2. 打开浏览器访问 `http://localhost:8080`

3. 找到 H265Player 视频播放器组件

4. 在输入框中粘贴 WVP 流地址

5. 点击"播放"按钮

6. 点击"显示调试"查看详细信息

#### 3. 观察调试信息

播放成功时，调试面板会显示：

```
✅ 检测到流类型: WS-FLV (或 FLV/HLS)
✅ 准备加载 WebSocket-FLV 流
✅ 创建 FLV 播放器
✅ 收到视频元数据
✅ 视频宽度: 1920px
✅ 视频高度: 1080px
✅ 帧率: 25 FPS
✅ FLV 流开始播放
✅ 连接完成，耗时: XXXms
```

## 🔍 流类型自动识别测试

组件会自动识别以下流类型：

| 流地址示例 | 识别结果 | 使用协议 |
|------------|----------|----------|
| `ws://host/xxx.flv` | WS-FLV | WebSocket-FLV |
| `ws://host/rtp/live` | WS-FLV | WebSocket-FLV |
| `http://host/xxx.live.flv` | FLV | HTTP-FLV |
| `http://host/xxx.m3u8` | HLS | HLS |
| `rtmp://host/live` | RTMP | 提示转码 |
| `rtsp://host/live` | RTSP | 提示转码 |

### 验证方法

在调试面板的事件日志中查看：

```
[时间] 检测到流类型: WS-FLV  ← 应显示正确的类型
[时间] 使用 WebSocket-FLV 协议（WVP 平台推流）
```

## 🧪 功能测试清单

### ✅ 基础功能

- [ ] **流地址输入**：可以输入各种 WVP 流地址
- [ ] **播放按钮**：点击后开始播放
- [ ] **停止按钮**：可以停止播放
- [ ] **重试按钮**：播放失败后可以重试

### ✅ 协议支持

- [ ] **WebSocket-FLV**：WVP 推荐格式，低延迟
- [ ] **HTTP-FLV**：标准 HTTP 传输
- [ ] **HLS**：M3U8 格式流

### ✅ 调试信息

- [ ] **连接状态**：显示正确的状态（未连接/连接中/播放中）
- [ ] **流类型检测**：自动识别流协议
- [ ] **视频信息**：显示分辨率、帧率、编码
- [ ] **性能统计**：显示帧数、丢帧、延迟
- [ ] **网络信息**：显示下载速度、字节数
- [ ] **事件日志**：实时显示播放过程

### ✅ 错误处理

- [ ] **流地址错误**：显示明确的错误信息
- [ ] **网络错误**：提示网络问题
- [ ] **服务器错误**：提示服务器未响应
- [ ] **格式错误**：提示不支持的格式

## 📋 测试用例

### 用例 1: WS-FLV 流播放

**前提条件**：
- WVP 平台运行在 `192.168.1.100:18080`
- 有一个在线的国标摄像头

**测试步骤**：
1. 输入流地址：`ws://192.168.1.100:18080/rtp/xxx_xxx.live.flv`
2. 点击"播放"
3. 观察调试信息

**预期结果**：
- 状态变为"播放中"
- 显示视频画面
- 调试信息显示 "WS-FLV"
- 事件日志无错误

### 用例 2: HTTP-FLV 流播放

**测试步骤**：
1. 输入流地址：`http://192.168.1.100:18080/rtp/xxx_xxx.live.flv`
2. 点击"播放"

**预期结果**：
- 成功播放
- 编码显示 "H.264/HTTP-FLV"

### 用例 3: HLS 流播放

**测试步骤**：
1. 输入流地址：`http://192.168.1.100:18080/rtp/xxx_xxx/hls.m3u8`
2. 点击"播放"

**预期结果**：
- 成功播放
- 编码显示 "H.264/HLS"

### 用例 4: 错误处理

**测试步骤**：
1. 输入错误的流地址：`ws://192.168.1.999:18080/rtp/wrong.flv`
2. 点击"播放"

**预期结果**：
- 显示错误提示
- 事件日志中有红色错误信息
- 错误信息明确指出问题

### 用例 5: 流切换

**测试步骤**：
1. 播放第一个流
2. 不停止，直接输入第二个流地址
3. 点击"播放"

**预期结果**：
- 自动停止第一个流
- 开始播放第二个流
- 无报错

## 🔧 常见问题排查

### 问题 1: 无法播放 WVP 流

**检查项**：
```bash
# 1. 检查 WVP 是否运行
curl http://192.168.1.100:18080/index/api/getServerConfig

# 2. 检查流是否存在
# 在 WVP 后台手动播放一次

# 3. 检查防火墙
# Windows: 允许 18080 端口
# Linux: sudo ufw allow 18080

# 4. 检查 CORS（如果跨域）
# 在 ZLMediaKit 配置中开启 CORS
```

### 问题 2: WebSocket 连接失败

**解决方案**：
1. 使用 HTTP-FLV 替代 WS-FLV
2. 检查 WebSocket 是否被代理/防火墙拦截
3. 确认流地址使用 `ws://` 而不是 `http://`

### 问题 3: 画面卡顿

**解决方案**：
1. 查看调试面板的"丢帧数"
2. 检查网络速度
3. 降低摄像头码率
4. 使用有线网络代替 WiFi

### 问题 4: 延迟过高

**优化建议**：
1. 使用 WebSocket-FLV 协议（延迟最低）
2. 在 WVP 配置中启用低延迟模式
3. 减小缓冲区大小

## 📊 性能基准

### 预期性能指标

| 协议 | 延迟 | 码率 | 适用场景 |
|------|------|------|----------|
| WS-FLV | 0.5-1秒 | 1-4Mbps | 实时监控 |
| HTTP-FLV | 1-2秒 | 1-4Mbps | 普通监控 |
| HLS | 3-10秒 | 1-4Mbps | 录像回放 |

### 测试数据示例

**良好状态**：
- 接收帧数: 稳定增长
- 解码帧数: ≈ 接收帧数
- 丢帧数: 0 或极少
- 下载速度: ≈ 视频码率
- 缓冲延迟: < 500ms

**需要优化**：
- 丢帧数: > 10/秒
- 下载速度: 不稳定或低于码率
- 缓冲延迟: > 1000ms

## ✨ 高级测试

### 1. 压力测试

同时播放多个流：
```javascript
const urls = [
  'ws://host/rtp/camera1.live.flv',
  'ws://host/rtp/camera2.live.flv',
  'ws://host/rtp/camera3.live.flv'
]

// 依次播放或使用多个播放器实例
```

### 2. 长时间稳定性测试

播放 1 小时以上，观察：
- 内存占用是否持续增长
- 是否出现卡顿
- 是否自动断开

### 3. 网络波动测试

模拟网络波动：
- 使用 Chrome DevTools 限速
- 观察播放器是否自动恢复
- 查看缓冲策略是否有效

## 📝 测试报告模板

```
测试日期：2025-10-29
测试人员：[姓名]
测试环境：
  - 浏览器：Chrome 120
  - WVP 版本：2.x
  - 网络：内网

测试结果：
✅ WS-FLV 播放正常
✅ HTTP-FLV 播放正常
✅ HLS 播放正常
✅ 调试信息正常
✅ 错误处理正常

性能数据：
  - 延迟：0.8秒
  - 帧率：25 FPS
  - 丢帧：0
  - 码率：2.5 Mbps

问题记录：
  [无] 或 [具体问题描述]

建议：
  [优化建议]
```

---

**测试通过标准**：
- ✅ 所有基础功能正常
- ✅ 三种协议都能播放
- ✅ 调试信息完整准确
- ✅ 错误处理友好清晰
- ✅ 性能指标符合预期

**更新日期**: 2025-10-29  
**版本**: 1.1.0

